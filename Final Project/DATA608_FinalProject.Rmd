---
title: "LIRR Ridership"
author: "Isabel R"
date: "5/15/2020"
output: 
  html_document:
    toc: true 
    toc_depth: 2
    toc_float: true
    code_folding : show
    theme: united
    highlight: tango
---


```{r setup, include=FALSE}
library(dplyr);library(ggplot2)
library(ggthemes); library(e1071); library(caTools); library(MASS); library(funModeling); library (plyr); library(stringr)
```

# Task

Your final project is to create a public visualization using data relevant to a current policy,business, or justice issue. You may use any dataset you can find for this assignment, aslong as it is either public or you have permission from the data’s owner/administrator to workwith it and share it.

Recommended data sources are: governmental data, data provided by a non-profit/Nongovernmental organizations, and data available from large, semi-structured data sets (ie social networks, company financials, etc).

You must document each step of your data analysis process (excluding data acquisition) in code: this will include changing the format of the data and the creation of any images or interactive displays that are made.

You must also include a short (2-3 paragraph) write-up on the visualization. This write-up must include the following: the data source, what the parameters of the data set are (geography, timeframe, what the data points are, etc) what the data shows, and why it is important.

# Overview 
For the DATA 608 Final project, I was interested in analyzing Long Island Rail Road Ridership statistics.I wanted to analyze and delve into the branch had the most ridership and determining which month had peak ridership.

# Data

I obtained the data from the MTA's Developer Reources, at:<br>
http://web.mta.info/persdashboard/perxml/MTA_Performance_Datall.zip. 

For my analysis I will be focusing on the following parameters:

PARENT_SEQ = "20421"
INDICATOR_NAME
PERIOD_YEAR
PERIOD_MONTH
MONTHLY_ACTUAL

The data dictionary can be found at:<br>
http://web.mta.info/developers/Performance_Indicators_by%20Agency.xls.

# Focus

At the moment,there are dashboards that currently exists which displays visuals for Ridership and On-Time Performance (OTP). I wanted to create an interactive visual to show Ridership by branch which was not publically available however branch data was avalble for OTP.

I would like analyze the following:<br>

1.Which branch had the best overal OTP in 2018 and 2019.
2.Which Month has the best overall OTP for all branches combined.


## Ridership
The following dashboard http://lirrdashboard.mta.info/Home/Ridership shows Total Ridership for the agency as a whole comparing 2019 Actual vs. 2020 Actual.

I wanted to recreate this visual comparing 2018 Actual vs. 2019 Actual.The paramaters in the data set are timeframe (Months) for 2019 and 2020.The data points represent actual customers or ridership that the LIRR serves in millions. In the graphic, ridership is highest in October. I would like to see the ridership trend, visually for several years. 

![2019 Actuals vs. 2020 Actuals](2020-03-13 13_15_12-Window.png)

## On Time Performance

The goal of the Performance Dashboard is to increase transparency at the MTA. The metric On Time Performance is the percent of commuter trains that arrive at their destinations within 5 minutes and 59 seconds of the scheduled tim. TheLIRR expects to acheive a system-wide on-time performance target of at least 95%.

The following dashboard http://web.mta.info/persdashboard/performance14.html shows On Time Performance by Month for 2019 Actuals and 2020 Actuals. The dashboard does not seem to have been updated since January 2020.

![On Time Performance Monthly - 2018 Actuals vs. 2019 Actuals](2020-03-13 10_09_47-MTA Stat Dashboard.png)

The following dashboard http://lirrdashboard.mta.info/Home/Main shows On Time Performance by Month by Branch for 2018 Actuals, 2019 Actuals and 2020 Actuals.

![On Time Performance Monthly By Branch - 2018 Actuals vs. 2019 Actuals vs. 2020 Actuals](2020-03-13 10_49_06-Long Island Rail Road Performance Dashboard.png)

# Analysis

## Load Data

```{r}
data <-read.csv("https://raw.githubusercontent.com/IsARam/CUNY_DATA_608/master/Final%20Project/MTA_Performance_LIRR.csv", header=TRUE, check.names = FALSE)
```

## Tidy Data

First I filtered data for OTP rows then removed unecessary columns. I then converted PERIOD_MONTH from a numerical value to a string then removed the string "Branch - OTP" from INDICATOR_NAME.I also renamed the columns.

```{r}
# Filter for OTP.
OTP<-data[ which(data$PARENT_SEQ=="20421"), ]

# Remove unecessary columns.
NEWOTP<-OTP[c(-1:-3, -5:-10, -13:-15)]

# Convert PERIOD_MONTH from a numerical value to a string.
NEWOTP1<-NEWOTP$PERIOD_MONTH<-with(NEWOTP, month.abb[PERIOD_MONTH])

# Remove the string "Branch - OTP" from INDICATOR_NAME.
NEWOTP2<-NEWOTP$INDICATOR_NAME<-with(NEWOTP,str_remove(NEWOTP$INDICATOR_NAME,fixed(" Branch - OTP ")))

# Rename the columns.
names(NEWOTP)<-c("Branch","Year","Month","Actual")
head(NEWOTP)
```


```{r}
summary(NEWOTP)
```

# Analysis

I first checked for the completeness of the data as some years were missing OTP values and some subway lines only had collected data from the mid-year. We removed all incomplete data including any years after 2011 and incomplete OTP for the subway lines W and S Line 42 St.

After, a Boolean comparison was done on the monthly actual vs. monthly target OTP and a new column, ON_TIME, was created with {1,0} values to indicate if the subway was on-time for that month.

Finally, the percentage values for OTP was changed to decimals, divided by approximately 20 days as only weekdays are considered in the collected data and added into a new column called DAYS_ON_TIME. I also did a quick check again on the Na's and O values to be sure there was no missing data remaining (excluding the variable ON_TIME as that can only be {1,0}) 

The new cleaned set was then export to .CSV to use in the shiny app. I also created two ggplots below using a facet wrap. 

```{r subway cleanse}
# check for data completeness to see how many subways were analyzed
unique(sub$INDICATOR_NAME)
# 24 subways were analyzed over 12 months so each year should have 288 values
table(sub$PERIOD_YEAR) 
# See if OTP was measured for all subway lines
table(sub$INDICATOR_NAME)
# remove the years 2009 and 2010 and standardize the remainder of the years be removing incomplete subway lines: S line 42 & the W line
sub.updated<-sub %>% 
  filter(PERIOD_YEAR >= "2011", INDICATOR_NAME != "OTP (Terminal) - W Line", INDICATOR_NAME != "OTP (Terminal) - S Line 42 St.")
# check on the data once more
table(sub.updated$PERIOD_YEAR) 
table(sub.updated$PERIOD_MONTH) 
#change line names by removing OTP (Terminal)
sub.updated$INDICATOR_NAME<-revalue(sub.updated$INDICATOR_NAME, c("OTP (Terminal) - 1 Line" = "one" , "OTP (Terminal) - 2 Line"="two", "OTP (Terminal) - 3 Line"="three","OTP (Terminal) - 4 Line"="four","OTP (Terminal) - 5 Line"="five","OTP (Terminal) - 6 Line"="six","OTP (Terminal) - 7 Line"="seven","OTP (Terminal) - A Line"="A","OTP (Terminal) - B Line"="B","OTP (Te rminal) - C Line"="C","OTP (Terminal) - E Line"="E","OTP (Terminal) - F Line"="F","OTP (Terminal) - D Line"="D","OTP (Terminal) - G Line"="G", "OTP (Terminal) - J Z Line" = "J Z","OTP (Terminal) - L Line"="L","OTP (Terminal) - M Line"="M","OTP (Terminal) - N Line"="N","OTP (Terminal) - Q Line"="Q","OTP (Terminal) - R Line"="R","OTP (Terminal) - S Fkln Line" = "S Fkln","OTP (Terminal) - S Line 42 St." = "S 42 St.","OTP (Terminal) - S Line Rock" = "S Rock", "OTP (Terminal) - W Line" = "W"))
```

```{r}
# change the structure of certain variables to factors
sub.updated$PERIOD_YEAR<-as.factor(sub.updated$PERIOD_YEAR)
sub.updated$PERIOD_MONTH<-as.factor(sub.updated$PERIOD_MONTH)
# compare the monthly actual OTP to the monthly target OTP and if the actual is >= then the value is true
sub.updated$ON_TIME <- as.numeric(sub.updated$MONTHLY_ACTUAL >= sub.updated$MONTHLY_TARGET)
# change percentages to decimals
sub.updated$MONTHLY_TARGET <-sub.updated$MONTHLY_TARGET/100
sub.updated$MONTHLY_ACTUAL <-sub.updated$MONTHLY_ACTUAL/100
sub.updated$YTD_TARGET <-sub.updated$YTD_TARGET/100
sub.updated$YTD_ACTUAL <-sub.updated$YTD_ACTUAL/100
# approximately 20 weekdays in a month as the OTP is only measured for weekdays
sub.updated$DAYS_ON_TIME<-sub.updated$MONTHLY_ACTUAL*20
#check for any missing values
df_status(sub.updated, print_results = TRUE)
```

```{r}
#export sub updated to .CSV to use the cleaned version in app 
write.csv(sub.updated,'C:\\users\\christinavalore\\Desktop\\MTA_CLEANED.csv', row.names = FALSE)
```

# Visualizations

Using ggplot2, we facet wrap the month vs. days on time with the year and see that after 2013, the days on time start to decrease, with the worst OTP in 2017. 

```{r}
#facet wrap by year
qplot(PERIOD_MONTH, DAYS_ON_TIME, data = sub.updated, facets = . ~ PERIOD_YEAR) + theme(axis.text.x = element_text(size = 5, angle = 90))
```

I then facet wrap the month vs days on tine with the subway line and see that the worst OTP comes from the 2 and 4/5 line. 

```{r}
#facet wrap by year
qplot(PERIOD_MONTH, DAYS_ON_TIME, data = sub.updated, facets = . ~ INDICATOR_NAME) + theme(axis.text.x = element_text(size = 3, angle = 90))
```

# Shiny App

Using the shiny app functionality, I then take the cleaned dataset and use dpylr to filter the date out by year and month to see how the subway lines perform. 

To see the subway OTP over the years in the month of November: https://cvalore.shinyapps.io/OTP_MONTH/

To see the subway OTP over the months for 2017: https://cvalore.shinyapps.io/OTP_YEAR/

I chose the year 2017 first as from the ggplot above it looked as if that was the poorest performing year. By examining the app, I could see December was often at the end of the graphs meaning it was the poorest scoring month.

So then I created an app that targeted just December over the years. 

# Conclusion

From my visualizations I would say that over the years the on-time performance for subways became poorer, specifically in the year 2017. As I imagined the winter months, like December and even at times November, showed poor on-time performance. 

I did a quick Google search to see if I could find any evidence to back my claims up as to say that 2017 was a low performing year and I found this article: https://NY.curbed.com/2017/6/14/15801694/mta-NYC-subway-delays-twitter titled: MTA WTF: A visual timeline of the subway’s epic 2017 meltdown.

Although the article is just stating how bad the MTA infrastructure and delays were in 2017, sighting only a handful examples, it is still interesting to see how this was something that was quite noticeable to NYC during this year. So noticeable that on Jun 29, 2017, the Governor declared a state of emergency for the NYC Subway!